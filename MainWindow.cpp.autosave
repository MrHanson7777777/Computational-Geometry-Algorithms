#include "mainwindow.h"
#include <QMenuBar>
#include <QMenu>
#include <QAction>
#include <QStatusBar>
#include <QApplication>
#include <QStyle>
#include <QMessageBox>
#include <QVBoxLayout>
#include <QPushButton>
#include <QLabel>
#include <QDialog>
#include <QCloseEvent>

/**
 * @brief MainWindow ç±»çš„æ„é€ å‡½æ•°
 * @param parent çˆ¶çª—å£éƒ¨ä»¶æŒ‡é’ˆ
 * @details
 * - åˆå§‹åŒ–ä¸»çª—å£ï¼Œåˆ›å»ºå¹¶è®¾ç½®æ ¸å¿ƒçš„ DrawingWidget ä¸ºä¸­å¿ƒæ§ä»¶ã€‚
 * - åˆå§‹åŒ–çŠ¶æ€æ å¹¶æ˜¾ç¤ºæ¬¢è¿ä¿¡æ¯ã€‚
 * - è¿æ¥ DrawingWidget çš„ä¿¡å·åˆ° MainWindow çš„æ§½å‡½æ•°ï¼Œä»¥å®ç°çŠ¶æ€æ›´æ–°å’Œèœå•æ§åˆ¶ã€‚
 * - è°ƒç”¨ createMenus() åˆ›å»ºæ‰€æœ‰èœå•å’Œå­èœå•ã€‚
 * - è®¾ç½®çª—å£æ ‡é¢˜ã€å¤§å°å’Œå…¨å±€çš„æ·±è‰²ä¸»é¢˜æ ·å¼è¡¨ (QSS)ã€‚
 */
MainWindow::MainWindow(QWidget *parent)
    : QMainWindow(parent)
{
    drawingWidget = new DrawingWidget(this);
    setCentralWidget(drawingWidget);

    //åˆå§‹åŒ–çŠ¶æ€æ 
    mainStatusBar = new QStatusBar(this);
    setStatusBar(mainStatusBar);
    mainStatusBar->showMessage("æ¬¢è¿ä½¿ç”¨è®¡ç®—å‡ ä½•å·¥å…·ï¼");

    //è¿æ¥ DrawingWidget çš„ä¿¡å·åˆ° MainWindow çš„æ§½
    connect(drawingWidget, &DrawingWidget::modeChanged, this, &MainWindow::updateStatus);
    //è¿æ¥ DrawingWidget çš„æ–°ä¿¡å·åˆ° MainWindow çš„æ–°æ§½
    connect(drawingWidget, &DrawingWidget::polygonsReady, this, &MainWindow::onPolygonsReady);

    createMenus();

    setWindowTitle("è½¯ä»¶å¼€å‘ç»¼åˆè®­ç»ƒå¤§ä½œä¸šâ€”â€”ä½•æ©æ° (C++/Qt)");
    resize(929, 523);

    //è®¾ç½®å…¨å±€QSSç¾åŒ–æ ·å¼
    qApp->setStyleSheet(
        "QMainWindow { background-color: #2E2E2E; }"
        "QMenuBar { background-color: #3C3C3C; color: #F0F0F0; }"
        "QMenuBar::item:selected { background-color: #555555; }"
        "QMenu { background-color: #3C3C3C; color: #F0F0F0; border: 1px solid #555; }"
        "QMenu::item:selected { background-color: #0078D7; }"
        "QStatusBar { color: #F0F0F0; }"
        );
}

/**
 * @brief MainWindow ç±»çš„ææ„å‡½æ•°
 */
MainWindow::~MainWindow()
{
}

/**
 * @brief æ›´æ–°çŠ¶æ€æ æ–‡æœ¬çš„æ§½å‡½æ•°
 * @param message ä» DrawingWidget å‘å°„çš„ã€è¦æ˜¾ç¤ºåœ¨çŠ¶æ€æ ä¸Šçš„æ–°æ¶ˆæ¯
 */
void MainWindow::updateStatus(const QString &message)
{
    mainStatusBar->showMessage(message);
}

/**
 * @brief æ ¹æ®å¤šè¾¹å½¢ç»˜åˆ¶çŠ¶æ€å¯ç”¨æˆ–ç¦ç”¨èœå•çš„æ§½å‡½æ•°
 * @param ready boolå€¼ï¼Œä¸º true æ—¶è¡¨ç¤ºä¸¤ä¸ªå¤šè¾¹å½¢å·²å‡†å¤‡å¥½ï¼Œåº”å¯ç”¨èœå•ï¼›false åˆ™ç¦ç”¨ã€‚
 * @details æ­¤æ§½å‡½æ•°ç”± DrawingWidget åœ¨å®Œæˆä¸¤ä¸ªå¤šè¾¹å½¢ç»˜åˆ¶åå‘å°„çš„ `polygonsReady` ä¿¡å·è§¦å‘ã€‚
 */
void MainWindow::onPolygonsReady(bool ready)
{
    // ç°åœ¨æ˜¯å¯ç”¨æˆ–ç¦ç”¨æ•´ä¸ªå­èœå•
    intersectionMenu->setEnabled(ready);
    unionMenu->setEnabled(ready);
}

/**
 * @brief åˆ›å»ºå¹¶åˆå§‹åŒ–ç¨‹åºçš„æ‰€æœ‰èœå•ã€å­èœå•å’ŒåŠ¨ä½œ
 * @details
 * - **æ–‡ä»¶èœå•**: åŒ…å«â€œæ¸…ç©ºå±å¹•â€å’Œâ€œé€€å‡ºâ€åŠŸèƒ½ã€‚
 * - **ç®—æ³•èœå•**: åŒ…å«æ‰€æœ‰æ ¸å¿ƒå‡ ä½•ç®—æ³•çš„å…¥å£ã€‚
 * - **è®¡ç®—å‡¸åŒ…**: è¢«è®¾ç½®ä¸ºä¸€ä¸ªå­èœå•ï¼Œå†…å« "Andrew ç®—æ³•" å’Œ "Graham ç®—æ³•" ä¸¤ä¸ªé€‰é¡¹ã€‚
 * - **è®¡ç®—äº¤å¹¶é›†**: ä¹Ÿæ˜¯ä¸€ä¸ªå­èœå•ï¼Œé¦–å…ˆæœ‰ä¸€ä¸ªâ€œå¼€å§‹ç»˜åˆ¶â€çš„å¯åŠ¨é¡¹ï¼Œ
 * ç„¶åæ˜¯ä¸¤ä¸ªé»˜è®¤ç¦ç”¨çš„å­èœå•â€œæ±‚äº¤é›†â€å’Œâ€œæ±‚å¹¶é›†â€ï¼Œæ¯ä¸ªå­èœå•å†…éƒ½æä¾›äº†
 * "QPainterPath æ³•" å’Œ "Weiler-Atherton æ³•" ä¸¤ç§ç®—æ³•é€‰é¡¹ã€‚
 * - **ä¸‰è§’å‰–åˆ†** å’Œ **è®¡ç®—é¢ç§¯**: ä½œä¸ºç›´æ¥çš„èœå•åŠ¨ä½œã€‚
 * - **æ‰§è¡Œè®¡ç®—èœå•**: æä¾›ä¸€ä¸ªå…¨å±€çš„â€œæ‰§è¡Œâ€æŒ‰é’®ï¼Œç”¨äºè§¦å‘å·²è®¾ç½®å¥½çš„è®¡ç®—ä»»åŠ¡ã€‚
 *
 * æ‰€æœ‰èœå•é¡¹éƒ½é€šè¿‡ `connect` å‡½æ•°ä¸ DrawingWidget ä¸­å¯¹åº”çš„æ§½å‡½æ•°ç›¸è¿ã€‚
 */
void MainWindow::createMenus()
{
    // --- æ–‡ä»¶èœå• ---
    QMenu *fileMenu = menuBar()->addMenu("æ–‡ä»¶");
    QAction *clearAction = new QAction("æ¸…ç©ºå±å¹•", this);
    clearAction->setIcon(style()->standardIcon(QStyle::SP_FileIcon));
    connect(clearAction, &QAction::triggered, drawingWidget, &DrawingWidget::clearScreen);
    fileMenu->addAction(clearAction);
    QAction *quitAction = new QAction("é€€å‡º", this);
    quitAction->setIcon(style()->standardIcon(QStyle::SP_DialogCloseButton));
    connect(quitAction, &QAction::triggered, this, &QWidget::close);
    fileMenu->addAction(quitAction);

    // --- ç®—æ³•èœå• ---
    QMenu *algorithmMenu = menuBar()->addMenu("ç®—æ³•");

    QMenu *convexHullMenu = algorithmMenu->addMenu("1. è®¡ç®—å‡¸åŒ…");
    QAction *andrewAction = new QAction("Andrew ç®—æ³• (Monotone Chain)", this);
    connect(andrewAction, &QAction::triggered, drawingWidget, &DrawingWidget::startAndrewConvexHull);
    convexHullMenu->addAction(andrewAction);
    QAction *grahamAction = new QAction("Graham ç®—æ³• (Graham Scan)", this);
    connect(grahamAction, &QAction::triggered, drawingWidget, &DrawingWidget::startGrahamConvexHull);
    convexHullMenu->addAction(grahamAction);

    intersectionUnionMenu = algorithmMenu->addMenu("2. è®¡ç®—å¤šè¾¹å½¢äº¤é›†ã€å¹¶é›†");
    QAction *startDrawingAction = new QAction("å¼€å§‹ç»˜åˆ¶", this);
    connect(startDrawingAction, &QAction::triggered, this, [this](){
        drawingWidget->setMode(DrawingWidget::DRAW_POLYGON_A);
    });
    intersectionUnionMenu->addAction(startDrawingAction);
    intersectionUnionMenu->addSeparator();

    // --- â€œæ±‚äº¤é›†â€å­èœå• ---
    intersectionMenu = intersectionUnionMenu->addMenu("æ±‚äº¤é›†");
    intersectionMenu->setEnabled(false);
    QAction *intersectActionQPath = new QAction("QPainterPath æ³•", this);
    connect(intersectActionQPath, &QAction::triggered, drawingWidget, &DrawingWidget::showIntersection_QPainterPath);
    intersectionMenu->addAction(intersectActionQPath);
    QAction *intersectActionWeiler = new QAction("Weiler-Atherton æ³•", this);
    connect(intersectActionWeiler, &QAction::triggered, drawingWidget, &DrawingWidget::showIntersection_Weiler);
    intersectionMenu->addAction(intersectActionWeiler);


    // --- â€œæ±‚å¹¶é›†â€å­èœå• ---
    unionMenu = intersectionUnionMenu->addMenu("æ±‚å¹¶é›†");
    unionMenu->setEnabled(false);
    QAction *unionActionQPath = new QAction("QPainterPath æ³•", this);
    connect(unionActionQPath, &QAction::triggered, drawingWidget, &DrawingWidget::showUnion_QPainterPath);
    unionMenu->addAction(unionActionQPath);
    QAction *unionActionWeiler = new QAction("Weiler-Atherton æ³•", this);
    connect(unionActionWeiler, &QAction::triggered, drawingWidget, &DrawingWidget::showUnion_Weiler);
    unionMenu->addAction(unionActionWeiler);

    // --- å…¶ä»–èœå•é¡¹ ---
    QAction *triangulateAction = new QAction("3. ä¸‰è§’å‰–åˆ†", this);
    connect(triangulateAction, &QAction::triggered, this, [this](){
        drawingWidget->setMode(DrawingWidget::DRAW_POLYGON);
        drawingWidget->setTask("triangulate");
    });
    algorithmMenu->addAction(triangulateAction);
    QAction *areaAction = new QAction("4. è®¡ç®—å¤šè¾¹å½¢é¢ç§¯", this);
    connect(areaAction, &QAction::triggered, this, [this](){
        drawingWidget->setMode(DrawingWidget::DRAW_POLYGON);
        drawingWidget->setTask("area");
    });
    algorithmMenu->addAction(areaAction);

    // --- æ‰§è¡Œèœå• ---
    QMenu *runMenu = menuBar()->addMenu("æ‰§è¡Œè®¡ç®—");
    QAction *runAction = new QAction("æ‰§è¡Œ", this);
    runAction->setIcon(style()->standardIcon(QStyle::SP_MediaPlay));
    connect(runAction, &QAction::triggered, drawingWidget, &DrawingWidget::performCalculation);
    runMenu->addAction(runAction);
}

/**
 * @brief é‡å†™çª—å£å…³é—­äº‹ä»¶ï¼Œåœ¨é€€å‡ºå‰æ˜¾ç¤ºä¸€ä¸ªæ„Ÿè°¢å¯¹è¯æ¡†
 * @param event å…³é—­äº‹ä»¶æŒ‡é’ˆ
 */
void MainWindow::closeEvent(QCloseEvent *event)
{
    QDialog dialog(this);
    dialog.setWindowTitle("ğŸ‰ æç¤º");

    QLabel *label = new QLabel("ğŸ˜„è°¢è°¢æ‚¨çš„ä½¿ç”¨ï¼<br>ğŸŒˆ ç¥æ‚¨ç”Ÿæ´»æ„‰å¿«ï¼");
    label->setStyleSheet("font-size: 16px; color: #0078D7; font-family: 'Microsoft YaHei';");

    QVBoxLayout *layout = new QVBoxLayout();
    layout->addWidget(label);

    QPushButton *okButton = new QPushButton("âœ… ç¡®å®š");
    okButton->setStyleSheet("padding: 6px 12px; background-color: #0078D7; color: white;");
    layout->addWidget(okButton);
    layout->setAlignment(okButton, Qt::AlignRight);

    QObject::connect(okButton, &QPushButton::clicked, &dialog, &QDialog::accept);

    dialog.setLayout(layout);
    dialog.exec();

    event->accept();
}
